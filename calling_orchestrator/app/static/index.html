<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI ìŒì„±ìƒë‹´ ì‹œìŠ¤í…œ</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f2f5;
        margin: 0;
      }
      .container {
        text-align: center;
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      p {
        color: #666;
        margin-bottom: 20px;
      }
      #status {
        font-weight: bold;
        font-size: 1.2em;
        min-height: 30px;
      }
      .status-listening {
        color: #28a745;
      }
      .status-speaking {
        color: #007bff;
      }
      .status-connecting {
        color: #ffc107;
      }
      .status-error {
        color: #dc3545;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #transcript {
        margin-top: 20px;
        color: #555;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>AI ìŒì„±ìƒë‹´ ì‹œìŠ¤í…œ</h1>
      <p>ìƒë‹´ì„ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
      <button id="startButton">ìƒë‹´ ì‹œì‘</button>
      <div id="status" class="status-connecting">ëŒ€ê¸° ì¤‘...</div>
      <div id="transcript"></div>
    </div>

    <script>
      const startButton = document.getElementById("startButton");
      const statusDiv = document.getElementById("status");
      const transcriptDiv = document.getElementById("transcript");
      let websocket;

      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = "ko-KR";
      recognition.interimResults = false;
      recognition.continuous = false;

      startButton.onclick = () => {
        const userPhone = prompt(
          "í…ŒìŠ¤íŠ¸í•  ì‚¬ìš©ìì˜ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 01012345678):",
          "01012345678"
        );
        if (!userPhone) return;

        startButton.disabled = true;
        statusDiv.textContent = "ì„œë²„ì— ì—°ê²° ì¤‘...";
        statusDiv.className = "status-connecting";

        websocket = new WebSocket(
          `ws://localhost:8000/api/ws/call/${userPhone}`
        );

        websocket.onopen = () => {
          console.log("WebSocket ì—°ê²° ì„±ê³µ");
          statusDiv.textContent =
            "ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. AIê°€ ì ì‹œ í›„ ì•ˆë‚´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.";
        };

        websocket.onmessage = (event) => {
          const message = event.data;
          console.log("ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ :", message);
          speak(message);
        };

        websocket.onclose = () => {
          console.log("WebSocket ì—°ê²° ì¢…ë£Œ");
          statusDiv.textContent = "ìƒë‹´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
          statusDiv.className = "";
          startButton.disabled = false;
        };

        websocket.onerror = (error) => {
          console.error("WebSocket ì˜¤ë¥˜:", error);
          statusDiv.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.";
          statusDiv.className = "status-error";
          startButton.disabled = false;
        };
      };

      function speak(text) {
        statusDiv.textContent = "AIê°€ ë§í•˜ëŠ” ì¤‘...";
        statusDiv.className = "status-speaking";
        transcriptDiv.textContent = `ğŸ¤– AI: ${text}`;

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "ko-KR";

        utterance.onend = () => {
          startListening();
        };

        window.speechSynthesis.speak(utterance);
      }

      function startListening() {
        statusDiv.textContent = "ë“£ëŠ” ì¤‘... ë§ì”€í•´ì£¼ì„¸ìš”.";
        statusDiv.className = "status-listening";
        recognition.start();
      }

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        console.log("ì‚¬ìš©ì ë‹µë³€(ìŒì„±ì¸ì‹):", transcript);
        transcriptDiv.textContent = `ğŸ‘¤ ë‚˜: ${transcript}`;

        if (websocket && websocket.readyState === WebSocket.OPEN) {
          websocket.send(transcript);
        }
      };

      recognition.onerror = (event) => {
        console.error("ìŒì„± ì¸ì‹ ì˜¤ë¥˜:", event.error);
        if (event.error === "no-speech") {
          statusDiv.textContent =
            "ìŒì„±ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.";
          setTimeout(startListening, 1000);
        } else {
          statusDiv.textContent = "ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          statusDiv.className = "status-error";
        }
      };
    </script>
  </body>
</html>
